# kong-oidc
## description
This plugin was initially started by a [Nokia open-source project](https://github.com/nokia/kong-oidc). Since the initial project has stopped being supported in 2019, it has been forked in 2021 by [another repo](https://github.com/revomatico/kong-oidc) which is archived since 2024.  
The plugin relies on the Nginx [lua-resty-openidc library](https://github.com/zmartzone/lua-resty-openidc) which is OIDC certified.
The lua-resty-openidc library allows an Nginx server to implement an Oauth2 resource server but it also allows to implement the responsibility of the OIDC Relying Party which off-load the responsibility from the front-end. Thanks to the library the state (access/ID/refresh tokens) of the session is encrypted and stored as a cookie.

## build & run
Build Kong image embedded with the OIDC plugin
```
podman build -t kong:kong-oidc .
```

Create podman network
```
podman network create foo
```

Spin up Kong, Keycloak and a HTTP mock assuming the role of a secured application.
```
podman play kube pods.yml --net foo
```

Configure the HTTP mock to return headers proxied by Kong.  
```
curl -v -X PUT "http://localhost:1080/mockserver/expectation" -d '{
    "httpRequest": {
        "path": "/"
    },
    "httpResponseTemplate": {
        "template": "{ \"statusCode\": 200, \"body\": \"$!request.headers\" }",
        "templateType": "VELOCITY"
    }
}'
```

Import an OIDC client from `keycloak-client.json` file in keycloak running on `http://localhost:8080/admin/master/console/#/master/clients`.  

Browse the resource server at:
```
http://localhost:8000/some/path
```

Prometheus metrics are available on the admin port at `http://localhost:8001/metrics`.  

Logout:
```
http://localhost:8000/logout
```

Shutdown:
```
podman play kube pods.yml --down
```

## configuration
### user info
The [open-source plugin](https://github.com/revomatico/kong-oidc) ignores the `session_contents` configuration provided by the [Lua resty openidc library](https://github.com/zmartzone/lua-resty-openidc/tree/v1.7.6?tab=readme-ov-file#sample-configuration-for-google-signin).  
This field allows to control what is stored into the session.  
An improvement to the open-source plugin is made in `utils.get_options()` function to disable the requests to the user-info endpoint (as the ID token is already stored). Otherwise the user-info endpoint is called after the code exchange (but for some reason it's not updated after token request see https://github.com/zmartzone/lua-resty-openidc/blob/v1.7.6/lib/resty/openidc.lua#L1165).

# troubleshooting
## `request to the redirect_uri path, but there's no session state found`
This error is raised when the plugin fails to get the session from the cookie.  
There are multiple causes for this issue:
- misconfigured redirect URI: if the configured redirect URI is not specific enough (i.e. the same as the route exposed by Kong), the user will hit this endpoint directly (before being redirected to the authorization server) and before having receive any cookie. Then Kong OIDC plugin consider it has to perform a code exchange and fail trying to identify the session.
- inconsistent scheme: if the flow is initiated over HTTP but the redirect URI is using HTTPS then the cookie won't be sent to the redirect URI endpoint.
- session secret: if not set, a default secret is generated by the Kong workers leading to different secrets being used and workers unable to decrypt the session encrypted by another worker.
- `SameSite` cookie attribute: the session cookie used by the Kong OIDC plugin should be set to `Lax` or `None` so that it's set even if the user land in the endpoint from a link
- header limit: since the cookie contains access/ID/refresh tokens it might be truncate if there is reverse proxy in front of Kong
## `state from argument: xxx does not match state restored from session: yyy`
As explained in the thread below, if 2 authentication are happening in parallel from the same user agent there can be a race condition.  
- tab1 is hitting the secured endpoint and receives a cookie with a state `s1`
- then tab2 is hiting the secured endpoint and receives a cookie with a state `s2`
- tab1 is authenticated against the IdP and redirected to the Kong gateway with a `state` query parameter `s1` while the cookie now contains the state `s2`   
https://github.com/zmartzone/lua-resty-openidc/issues/482#issuecomment-1582584374
